"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports._internals = exports.ResolveError = void 0;
const useInventory_js_1 = __importDefault(require("../hooks/useInventory.js"));
const pkg_js_1 = require("../utils/pkg.js");
const useCellar_js_1 = __importDefault(require("../hooks/useCellar.js"));
const error_js_1 = require("../utils/error.js");
class ResolveError extends error_js_1.TeaError {
    constructor(pkg) {
        super(`not-found: pkg: ${(0, pkg_js_1.str)(pkg)}`);
        Object.defineProperty(this, "pkg", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        this.pkg = pkg;
    }
}
exports.ResolveError = ResolveError;
/// resolves a list of package specifications based on what is available in
/// bottle storage if `update` is false we will return already installed pkgs
/// that resolve so if we are resolving `node>=12`, node 13 is installed, but
/// node 19 is the latest we return node 13. if `update` is true we return node
/// 19 and *you will need to install it*.
async function resolve(reqs, { update } = { update: false }) {
    const inventory = exports._internals.useInventory();
    const cellar = exports._internals.useCellar();
    const rv = { pkgs: [], installed: [], pending: [] };
    let installation;
    for (const req of reqs) {
        if (!update && (installation = await cellar.has(req))) {
            // if something is already installed that satisfies the constraint then use it
            rv.installed.push(installation);
            rv.pkgs.push(installation.pkg);
        }
        else {
            const version = await inventory.select(req);
            if (!version) {
                throw new ResolveError(req);
            }
            const pkg = { version, project: req.project };
            rv.pkgs.push(pkg);
            if ((installation = await cellar.has(pkg))) {
                rv.installed.push(installation);
            }
            else {
                rv.pending.push(pkg);
            }
        }
    }
    return rv;
}
exports.default = resolve;
exports._internals = {
    useInventory: useInventory_js_1.default,
    useCellar: useCellar_js_1.default
};
